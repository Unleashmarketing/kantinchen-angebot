<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Laras Kantinchen | Konfigurator V2</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap');

        :root {
            --primary-color: #5d4037;
            --accent-orange: #e67e22;
        }

        body { font-family: 'Open Sans', sans-serif; background: #95a5a6; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* --- EDITOR SIDEBAR --- */
        .editor-panel { width: 420px; background: white; padding: 20px; box-shadow: 2px 0 15px rgba(0,0,0,0.2); overflow-y: auto; z-index: 10; }
        h2 { color: var(--primary-color); font-size: 16px; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-top: 20px; text-transform: uppercase; }
        
        .section-box { background: #fdfaf9; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 11px; font-weight: bold; color: #555; margin-bottom: 4px; text-transform: uppercase; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; font-size: 13px;
        }

        .btn { padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; color: white; transition: opacity 0.2s; }
        .btn-truck { background: var(--primary-color); }
        .btn-food { background: var(--accent-orange); margin-top: 10px; }
        .btn-print { background: #27ae60; margin-top: 30px; font-size: 16px; }

        /* --- A4 PREVIEW --- */
        .preview-panel { flex-grow: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; gap: 40px; }
        .a4-page { 
            width: 210mm; min-height: 297mm; background: white; padding: 20mm; 
            box-shadow: 0 0 20px rgba(0,0,0,0.4); box-sizing: border-box; position: relative; 
            display: flex; flex-direction: column; page-break-after: always;
        }

        .header-logo { position: absolute; top: 15mm; right: 20mm; width: 40mm; }
        .sender-line { font-size: 7.5pt; color: #777; text-decoration: underline; margin-bottom: 8mm; }
        .address-box { font-size: 11pt; margin-bottom: 15mm; line-height: 1.4; min-height: 30mm; }
        .event-info { font-size: 10pt; margin-bottom: 5mm; border-collapse: collapse; }
        .event-info td { padding: 3px 0; }
        .event-info td:first-child { font-weight: bold; width: 35mm; }
        
        .reserviert-banner { color: var(--accent-orange); font-weight: bold; font-style: italic; text-align: center; font-size: 14pt; margin: 15mm 0; }
        .intro-text { font-size: 11pt; line-height: 1.6; white-space: pre-wrap; }

        .offer-header-small { font-size: 9pt; color: #555; margin-bottom: 5mm; }
        
        /* TABELLE ANPASSUNG */
        .truck-table { width: 100%; border-collapse: collapse; margin-bottom: 10mm; font-size: 8.5pt; table-layout: fixed; }
        .truck-table th, .truck-table td { border: 1px solid #000; padding: 6px; vertical-align: top; overflow-wrap: break-word; }
        
        /* Spaltenbreiten */
        .col-pos { width: 45%; } /* Doppelt so breit */
        .col-qty { width: 8%; }
        .col-money { width: 11.75%; }

        .truck-title { color: #e74c3c; font-weight: bold; font-size: 13pt; text-align: center; background: #fff !important; }
        .totals-row { font-weight: bold; background: #f9f9f9; }
        .delete-overlay { color: red; cursor: pointer; font-weight: bold; font-size: 14px; margin-left: 10px; }

        @media print {
            .editor-panel, .delete-overlay, .no-print { display: none !important; }
            .preview-panel { padding: 0; background: white; overflow: visible; }
            .a4-page { box-shadow: none; margin: 0; width: 210mm; height: 297mm; }
            body { background: white; }
        }
    </style>
</head>
<body>

<div class="editor-panel">
    <h2>1. Einleitungstext</h2>
    <div class="section-box">
        <div class="form-group">
            <label>Anschreiben</label>
            <textarea id="edit-intro" rows="6" oninput="updateIntro()">Sehr geehrte Damen und Herren,

vielen Dank für Ihre Anfrage. 
Anbei übersenden wir Ihnen die ausgearbeiteten Vorschläge für Ihr Event.

Wir freuen uns auf Ihre Rückmeldung!</textarea>
        </div>
    </div>

    <h2>2. Trucks & Speisen</h2>
    <div class="section-box">
        <div class="form-group">
            <label>Truck Name</label>
            <input type="text" id="truck-name" placeholder="z.B. TRUCK 1">
        </div>
        <button class="btn btn-truck" onclick="addTruck()">+ Truck hinzufügen</button>
        
        <hr style="margin:15px 0; border:0; border-top:1px solid #ddd;">
        
        <div class="form-group">
            <label>Ziel-Truck</label>
            <select id="food-target"></select>
        </div>
        <div class="form-group">
            <label>Produkt-Vorlagen</label>
            <select id="food-presets" onchange="loadPreset()">
                <option value="">-- Bitte wählen --</option>
                <optgroup label="Pastrami Sandwiches">
                    <option value="ps_sally">Pastrami Sandwich Sally</option>
                    <option value="ps_harry">Pastrami Sandwich Harry</option>
                    <option value="ps_maxi">Pastrami Sandwich Maxi</option>
                </optgroup>
                <optgroup label="Pastrami Bowls">
                    <option value="pb_sally">Pastrami Bowl Sally</option>
                    <option value="pb_harry">Pastrami Bowl Harry</option>
                    <option value="pb_maxi">Pastrami Bowl Maxi</option>
                </optgroup>
                <optgroup label="Vegi / Vegan">
                    <option value="spaetzle">Käsespätzle</option>
                    <option value="salat">Pflücksalat mit Wassermelone</option>
                    <option value="curry">Vegan Linsen-Curry</option>
                    <option value="maultaschen">Maultaschen</option>
                </optgroup>
                <optgroup label="Klassiker">
                    <option value="pommes">Pommes Frites</option>
                    <option value="wurst">Bratwurst / Saumagen</option>
                    <option value="service">Servicegebühr & Truck</option>
                </optgroup>
            </select>
        </div>
        <div class="form-group">
            <label>Titel / Preis / Menge</label>
            <input type="text" id="food-title" style="margin-bottom:5px">
            <div style="display:flex; gap:5px">
                <input type="number" id="food-qty" value="1">
                <input type="number" id="food-price" step="0.01" placeholder="Preis Brutto">
            </div>
        </div>
        <div class="form-group">
            <label>Beschreibung</label>
            <textarea id="food-desc" rows="3"></textarea>
        </div>
        <button class="btn btn-food" onclick="addFood()">Speise hinzufügen</button>
    </div>

    <button class="btn btn-print" onclick="window.print()">ANGEBOT DRUCKEN (PDF)</button>
</div>

<div class="preview-panel">
    <div class="a4-page" id="page-1">
        <img src="https://via.placeholder.com/200x120?text=LARAS+LOGO" class="header-logo">
        <div class="sender-line">Laras Kantinchen, Chr.-Kröwerath-Straße 132, 67071 Ludwigshafen</div>
        <div class="address-box" id="out-recipient"></div>
        <div style="text-align: right; font-size: 10.5pt; margin-bottom: 5mm;" id="out-today"></div>
        <table class="event-info">
            <tr><td>Catering:</td><td id="out-date"></td></tr>
            <tr><td>Event:</td><td id="out-event"></td></tr>
            <tr><td>Ort / Location:</td><td id="out-location"></td></tr>
            <tr><td>Uhrzeit:</td><td id="out-time"></td></tr>
            <tr><td>Angebot Nr.:</td><td id="out-offer-id"></td></tr>
        </table>
        <div class="reserviert-banner">Reserviert bis zum <span id="out-valid-until"></span></div>
        <div class="intro-text" id="out-intro"></div>
    </div>

    <div class="a4-page" id="page-2">
        <img src="https://via.placeholder.com/200x120?text=LARAS+LOGO" class="header-logo">
        <div class="offer-header-small">
            Hier unser Angebot für den vorgenannten Event:<br>
            <strong>Angebot Nr. <span id="out-offer-id-2"></span></strong>
        </div>
        <div id="tables-container"></div>
    </div>
</div>

<script>
    const presets = {
        ps_sally: { title: "Pastrami Sandwich Sally", price: 8.50, desc: "Gegrillte Pastrami zwischen 2 gerösteten Roggenmischbrot mit mildem Senf, Sandwichgurken, knackiger Salat, Röstzwiebeln, hausgemachter Cocktailsoße und geschmolzenem Cheddar" },
        ps_harry: { title: "Pastrami Sandwich Harry", price: 8.50, desc: "Gegrillte Pastrami zwischen 2 gerösteten Roggenmischbrotscheiben mit mildem Senf, Sandwichgurken und hausgemachtem Krautsalat" },
        ps_maxi: { title: "Pastrami Sandwich Maxi", price: 9.50, desc: "Gegrillte Pastrami zwischen 2 gerösteten Roggenmischbrot mit mildem Senf, Sandwichgurken, knackiger Salat, Röstzwiebeln, hausgemachter Cocktailsoße, geschmolzenem Cheddar und ein doppelseitig gebratenes Spiegelei" },
        pb_sally: { title: "Pastrami Bowl Sally", price: 8.50, desc: "Gegrillte Pastrami auf knackigem Salat mit mildem Senf, Sandwichgurken, knackiger Salat, Röstzwiebeln, hausgemachter Cocktailsoße und geschmolzenem Cheddar" },
        pb_harry: { title: "Pastrami Bowl Harry", price: 8.50, desc: "Gegrillte Pastrami auf knackigem Salat mit mildem Senf, Sandwichgurken und hausgemachtem Krautsalat" },
        pb_maxi: { title: "Pastrami Bowl Maxi", price: 9.50, desc: "Gegrillte Pastrami auf knackigem Salat mit mildem Senf, Sandwichgurken, knackiger Salat, Röstzwiebeln, hausgemachter Cocktailsoße, geschmolzenem Cheddar und ein doppelseitig gebratenes Spiegelei" },
        spaetzle: { title: "Käsespätzle mit Original Bergkäse-Mischung – vegetarisch", price: 8.50, desc: "Dazu Röstzwiebeln und frische Kräuter an Salatbouquet" },
        salat: { title: "Bunter Pflücksalat mit frischer Wassermelone", price: 7.50, desc: "An Hirtenkäsewürfel an hausgem. Kräutervinaigrette dazu Baguette" },
        curry: { title: "Veganes Linsen-Curry (pikant)", price: 8.50, desc: "Mit frischem Koriander, einem Klecks creme vega & Limette an Basmatireis" },
        pommes: { title: "Portion Pommes Frites (frisch)", price: 4.50, desc: "Incl. Heinz-Ketchup / Heinz-Pommes Soße" },
        wurst: { title: "Bratwurst / Saumagenbratwurst oder Feuerwurst", price: 5.50, desc: "Im Brötchen incl. Ketchup / Senf" },
        maultaschen: { title: "Geschmelzte Maultaschen", price: 8.50, desc: "Mit Röstzwiebeln und Balsamicoreduktion an Salatbouquet" },
        service: { title: "Servicegebühr inkl. Anfahrt", price: 500.00, desc: "Auf- und Abbau und Verköstigungszeit mit 1 Oldtimer Truck, 2-3 x Personal, Blumen- und Kräuterdeko, Vorbereitung, Bioverpackungen und Biobesteck, Servietten, Palmblattteller, Fahrtkosten und Endreinigung" }
    };

    let trucks = [];

    function init() {
        const p = new URLSearchParams(window.location.search);
        if(p.get('recipient')) {
            document.getElementById('out-recipient').innerHTML = decodeURIComponent(escape(atob(p.get('recipient')))).replace(/\n/g, '<br>');
            document.getElementById('out-event').textContent = p.get('event');
            document.getElementById('out-location').textContent = p.get('location');
            document.getElementById('out-time').textContent = p.get('time');
            document.getElementById('out-offer-id').textContent = p.get('offerId');
            document.getElementById('out-offer-id-2').textContent = p.get('offerId');
            document.getElementById('out-valid-until').textContent = formatDate(p.get('validUntil'));
            document.getElementById('out-date').textContent = "am " + formatDate(p.get('date'));
            document.getElementById('out-today').textContent = new Date().toLocaleDateString('de-DE', { day: 'numeric', month: 'long', year: 'numeric' });
            updateIntro();
        }
    }

    function formatDate(iso) { return iso ? iso.split('-').reverse().join('.') : ''; }
    function updateIntro() { document.getElementById('out-intro').textContent = document.getElementById('edit-intro').value; }
    
    function loadPreset() {
        const key = document.getElementById('food-presets').value;
        if(presets[key]) {
            document.getElementById('food-title').value = presets[key].title;
            document.getElementById('food-desc').value = presets[key].desc;
            document.getElementById('food-price').value = presets[key].price;
        }
    }

    function addTruck() {
        const name = document.getElementById('truck-name').value || "Truck " + (trucks.length + 1);
        trucks.push({ id: Date.now(), name: name.toUpperCase(), items: [] });
        updateTruckList();
        render();
    }

    function removeTruck(id) {
        trucks = trucks.filter(t => t.id !== id);
        updateTruckList();
        render();
    }

    function updateTruckList() {
        const sel = document.getElementById('food-target');
        sel.innerHTML = trucks.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    }

    function addFood() {
        const tId = document.getElementById('food-target').value;
        const truck = trucks.find(t => t.id == tId);
        if(!truck) return alert("Bitte erst einen Truck anlegen!");
        const br = parseFloat(document.getElementById('food-price').value) || 0;
        truck.items.push({ id: Date.now(), title: document.getElementById('food-title').value, desc: document.getElementById('food-desc').value, qty: parseInt(document.getElementById('food-qty').value) || 1, br: br, ne: br / 1.07 });
        render();
    }

    function removeFood(tId, fId) {
        const truck = trucks.find(t => t.id == tId);
        truck.items = truck.items.filter(f => f.id !== fId);
        render();
    }

    function render() {
        const container = document.getElementById('tables-container');
        container.innerHTML = "";
        trucks.forEach(t => {
            let sN = 0, sB = 0;
            let rows = t.items.map(f => {
                const tN = f.qty * f.ne; const tB = f.qty * f.br;
                sN += tN; sB += tB;
                return `<tr>
                    <td class="col-pos"><strong>${f.title}</strong><br><small>${f.desc}</small><span class="delete-overlay no-print" onclick="removeFood(${t.id}, ${f.id})"> [x]</span></td>
                    <td align="center" class="col-qty">${f.qty}</td>
                    <td align="right" class="col-money">${f.ne.toFixed(2)}</td>
                    <td align="right" class="col-money">${f.br.toFixed(2)}</td>
                    <td align="right" class="col-money">${tN.toFixed(2)}</td>
                    <td align="right" class="col-money">${tB.toFixed(2)}</td>
                </tr>`;
            }).join('');
            
            container.innerHTML += `
                <table class="truck-table">
                    <thead>
                        <tr><th colspan="6" class="truck-title">${t.name} <span class="no-print" style="font-size:8pt; cursor:pointer;" onclick="removeTruck(${t.id})">[Truck entfernen]</span></th></tr>
                        <tr style="background:#eee">
                            <th class="col-pos">Position</th><th class="col-qty">Menge</th><th class="col-money">Einzel € netto</th><th class="col-money">Einzel € brutto</th><th class="col-money">Gesamt € netto</th><th class="col-money">Gesamt € brutto</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                        <tr class="totals-row">
                            <td colspan="4">Summe aller Positionen ${t.name}</td>
                            <td align="right">${sN.toFixed(2)} €</td>
                            <td align="right">${sB.toFixed(2)} €</td>
                        </tr>
                    </tbody>
                </table>`;
        });
    }

    init();
</script>
</body>
</html>
